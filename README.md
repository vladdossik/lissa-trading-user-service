# Lissa Trading User Service

**Lissa Trading User Service** — это микросервис, основная задача которого заключается в управлении
всеми операциями, связанными с пользователями, включая хранение информации, работу с сущностями и сбор статистики. Он
также взаимодействует с внешними сервисами для получения данных о портфелях пользователей и другой релевантной
информации.

## Разработка на проекте

- Ветки называем по идентификатору задачи: `feat(STOCK-1)` или `bugfix(STOCK-1)`
- Креды от серверов, баз данных и других ресурсов не прописываем в коде, используем переменные окружения
- Все фичи проверяются локально, покрываются тестами (unit и integration), затем проверяются на сервере, и только после
  этого переводятся в done
- Комментарии к задаче пишем на английском языке с чётким описанием выполненной работы
- Одна ветка — одна задача. Несколько задач в одной ветке не допускаются
- Все сервисы используют одну базу данных с разными схемами
- Схема базы должна называться по имени сервиса, например: `user_service_db`

## Структура проекта

```text
lissa-trading-user-service
│
├── src/main/java/lissa/trading/user/service/
│   ├── aspect/               - Аспекты (AOP) для управления пересекающимися задачами
│   │   └── LogEndpointAspect - Логирование вызовов различных конечных точек
│   ├── config/               - Файлы конфигурации сервиса
│   │   └── SwaggerConfig     - Конфигурация Swagger для документации API
│   ├── controller/           - REST API контроллеры
│   │   └── InternalController - Внутренний API для взаимодействия между сервисами
│   │   └── UserController    - Управление пользовательскими конечными точками (CRUD операции)
│   │   └── UserRegController - Управление регистрацией пользователей
│   ├── dto/                  - Объекты передачи данных (DTO)
│   │   ├── patch/            - DTO для PATCH запросов
│   │   ├── post/             - DTO для POST запросов
│   │   └── response/         - DTO для ответов
│   ├── tinkoff/              - Логика для интеграции с сервисом Тинькофф
│   ├── event/                - Компоненты событийной архитектуры
│   │   └── TempUserSavedEvent - Событие при сохранении временного пользователя
│   ├── exception/            - Обработка исключений
│   │   └── UnauthorizedException
│   │   └── UserCreationException
│   │   └── UserNotFoundException
│   ├── feign/                - Feign-клиенты для взаимодействия с другими сервисами
│   │   └── InternalTokenFeignIntercept - Перехватчик токенов для Feign-клиентов
│   │   └── TinkoffAccountClient - Клиент для общения с сервисом Тинькофф
│   ├── handler/              - Логика обработки событий
│   │   └── GlobalExceptionHandler - Глобальная обработка исключений
│   │   └── TempUserSavedEventListen - Обработчик события сохранения временного пользователя
│   ├── mapper/               - Мапперы для преобразования между сущностями и DTO
│   │   └── PageMapper        - Маппер для работы с пагинацией
│   │   └── TempUserRegMapper - Маппер для регистрации временных пользователей
│   │   └── UserMapper        - Маппер для данных пользователей
│   ├── model/                - Модели сущностей для работы с базой данных
│   │   ├── entity/           - JPA-сущности
│   │   │   └── User          - Главная сущность, представляющая пользователя
│   │   │   └── UserDailyStats - Сущность для хранения ежедневной статистики пользователей
│   ├── page/                 - Настраиваемая поддержка пагинации
│   │   └── CustomPage        - Кастомная структура для страниц в ответах
│   ├── repository/           - Репозитории для работы с базой данных
│   │   └── UserRepository    - Хранение и извлечение данных пользователей
│   │   └── TempUserRegRepository - Хранение данных временной регистрации пользователей
│   ├── security/             - Конфигурация безопасности
│   │   └── internal/         - Вспомогательные утилиты для безопасности
│   │   └── jwt/              - Логика обработки JWT токенов
│   │   └── WebSecurityConfig - Конфигурация безопасности веб-сервисов
│   ├── service/              - Бизнес-логика для работы сервиса
│   │   ├── creation/         - Операции, связанные с созданием пользователей
│   │   ├── stat/             - Управление статистическими данными пользователей
│   │   └── UserService       - Главный сервис для бизнес-логики пользователей
│   └── LissaTradingUserServiceApplication - Запуск приложения
├── src/main/resources/
│   └── db.changelog/         - Changelog для миграции базы данных
│   └── application.yaml      - Конфигурация уровня приложения (local и prod)
│   └── application-local.yaml - Конфигурация для локальной среды
│   └── application-prod.yaml - Конфигурация для продакшена
├── deployment.yaml           - Конфигурация для деплоя сервиса
├── Dockerfile                - Конфигурация Docker для контейнеризации
└── pom.xml                   - Файл конфигурации Maven
```

## Назначение сервиса

**Lissa Trading User Service** выполняет ключевую роль в управлении данными пользователей и статистикой для торговой
системы. Основные функции сервиса:

### Управление пользователями

Сервис обрабатывает создание, обновление и получение информации о пользователях. Операции с пользователями реализованы
через `UserController`, а данные хранятся в базе с помощью `UserRepository`.

### Регистрация пользователей

Сервис поддерживает регистрацию новых пользователей через `UserRegController` и отслеживает временные регистрации с
использованием `TempUserRegRepository`.

### Интеграция с Тинькофф

Сервис взаимодействует с сервисом Тинькофф через `TinkoffAccountClient`, чтобы получать данные о портфелях пользователей
и выполнять другие операции, связанные с этим сервисом.

### Статистика пользователей

Сервис собирает и отслеживает статистику пользователей, такую как ежедневная активность, с использованием сущности
`UserDailyStats`. Также он взаимодействует с другими сервисами для аналитической обработки данных.

## Kubernetes Deployment

Для развёртывания сервиса в Kubernetes предусмотрены следующие конфигурационные файлы:
`deployment.yaml`, `service.yaml`.